<!DOCTYPE html>
<html lang="zh-cn">
    <head>
    <meta http-equiv="content-type" content="text/html;charset=utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="robots" content="noodp"/>
    <meta name="author" content="Rockwinder">
    <meta name="description" content="Rockwinder 的个人博客">
    
    
    <link rel="prev" href="https://rockwinder.github.io/post/%E7%A0%94%E5%8F%91%E6%A8%A1%E5%BC%8F%E5%92%8C%E6%B5%81%E7%A8%8B%E7%9A%84%E5%86%8D%E6%80%9D%E8%80%83/" />
    <link rel="next" href="https://rockwinder.github.io/post/macos_gdb_install/" />
    <link rel="canonical" href="https://rockwinder.github.io/post/traceroute/" />
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">
    <link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">
    <meta name="msapplication-TileColor" content="#da532c">
    <meta name="theme-color" content="#ffffff">
    <title>
        
        
            路由追踪程序Traceroute分析与科普 | Rockwinder`s Blog
        
    </title>
    <meta name="title" content="路由追踪程序Traceroute分析与科普 | Rockwinder`s Blog">
    
<link rel="stylesheet" href="/css/main.min.css">


    
    
 

<script type="application/ld+json">
{
    "@context" : "http://schema.org",
    "@type" : "BlogPosting",
    "mainEntityOfPage": {
         "@type": "WebPage",
         "@id": "https:\/\/rockwinder.github.io\/"
    },
    "articleSection" : "post",
    "name" : "路由追踪程序Traceroute分析与科普",
    "headline" : "路由追踪程序Traceroute分析与科普",
    "description" : "路由追踪程序Traceroute分析与科普",
    "inLanguage" : "zh-cn",
    "author" : "Rockwinder",
    "creator" : "Rockwinder",
    "publisher": "Rockwinder",
    "accountablePerson" : "Rockwinder",
    "copyrightHolder" : "Rockwinder",
    "copyrightYear" : "2020",
    "datePublished": "2020-06-02 21:47:31 \x2b0700 \x2b07",
    "dateModified" : "2020-06-02 21:47:31 \x2b0700 \x2b07",
    "url" : "https:\/\/rockwinder.github.io\/post\/traceroute\/",
    "wordCount" : "3152",
    "keywords" : [ "traceroute", "Rockwinder`s Blog"]
}
</script>

  </head>
    <body class="">
        <div class="wrapper">
            <nav class="navbar">
    
        <progress class="content_progress" max="0" value="0"></progress>
    
    <div class="container">
        
            <div class="navbar-header header-back2home-logo">
                <span class="logo_mark" >>$</span>
                <a href="https://rockwinder.github.io/">
                    <span class="logo_text" >cd /home/</span>
                    <span class="logo_cursor" ></span>
                </a>
            </div>
        
        <div class="navbar-right">
                
                <span class="menu">
                
                <a class="menu-item" href="/post/" title="">Blog</a>
                
                <a class="menu-item" href="/categories/" title="">Categories</a>
                
                <a class="menu-item" href="/tags/" title="">Tags</a>
                
                <a class="menu-item" href="/about/" title="">About</a>
                
                <span class="divide"></span>
                <a href="javascript:void(0);" class="theme-switch"><i class="iconfont icon-dark-mode"></i></a>
                </span>
        </div>
    </div>
</nav>
<nav class="navbar-mobile" id="nav-mobile" style="display: none">
    
        <progress class="content_progress" max="0" value="0"></progress>
    
     <div class="container">
        <div class="navbar">
            <div class="navbar-header header-logo">
                    <a href="https://rockwinder.github.io/">Rockwinder`s Blog</a>
            </div>
            <div class="navbar-right">
                <div><a href="javascript:void(0);" class="theme-switch"><i class="iconfont icon-dark-mode"></i></a></div>
                <div class="menu-toggle">
                    <span></span><span></span><span></span>
                </div>
            </div>
        </div>
     
          <div class="menu" id="mobile-menu">
                <nav class="mb-md">
                    
                    
                        <a class="menu-item" href="/post/" title="">
                            <h3>Blog</h3>
                            <div class="menu-active"></div>
                        </a>
                    
                        <a class="menu-item" href="/categories/" title="">
                            <h3>Categories</h3>
                            <div class="menu-active"></div>
                        </a>
                    
                        <a class="menu-item" href="/tags/" title="">
                            <h3>Tags</h3>
                            <div class="menu-active"></div>
                        </a>
                    
                        <a class="menu-item" href="/about/" title="">
                            <h3>About</h3>
                            <div class="menu-active"></div>
                        </a>
                    
                </nav>
        </div>
    </div>
</nav>
            <main class="main">
                <div class="container">
                    
<article class="post-warp" itemscope itemtype="http://schema.org/Article">
    <header class="post-header">
        <h1 class="post-title" itemprop="name headline">路由追踪程序Traceroute分析与科普</h1>
        <div class="post-meta">
                Written by <a itemprop="name" href="https://rockwinder.github.io/" rel="author">Rockwinder</a> with ♥
                <span class="post-time">
                on <time datetime=2020-06-02 itemprop="datePublished">June 2, 2020</time>
                </span>
                in
                
                <i class="iconfont icon-folder"></i>
                <span class="post-category">
                        
                        
                        
                          <a href="https://rockwinder.github.io/categories/linux/"> linux, </a>
                        
                        
                </span>
                <span class="post-word-count">3152 words</span>
        </div>
    </header>

    <div class="post-content">
        

        
        
            
        

        
        
        
        
        

        
        
        

        <p>一、路由追踪程序traceroute/tracert
Traceroute是Linux和Mac OS等系统默认提供的路由追踪小程序，Tracert是Windows系统默认提供的路由追踪小程序。二者的功能相同，都能探测数据包从源地址到目的地址经过的路由器的IP地址。Traceroute/Tracert的实现都借助了TTL：通过向目的地址发送一系列的探测包，设置探测包的TTL初始值分别为1,2,3…，根据返回的超时通知（ICMP Time Exceeded Message）得到源地址与目的地址之间的每一跳路由信息。虽然两者输出结果一致，但在实现原理上还有着显著的差别。</p>
<p>二、Traceroute实现原理
<img src="https://image.3001.net/images/20161026/14774974948698.png!small" alt=""></p>
<ol>
<li>
<p>从源地址发出一个UDP探测包到目的地址，并将TTL设置为1；</p>
</li>
<li>
<p>到达路由器时，将TTL减1；</p>
</li>
<li>
<p>当TTL变为0时，包被丢弃，路由器向源地址发回一个ICMP超时通知（ICMP Time Exceeded Message），内含发送IP包的源地址，IP包的所有内容及路由器的IP地址；</p>
</li>
<li>
<p>当源地址收到该ICMP包时，显示这一跳路由信息；</p>
</li>
<li>
<p>重复1～5，并每次设置TTL加1；</p>
</li>
<li>
<p>直至目标地址收到探测数据包，并返回端口不可达通知（ICMP Port Unreachable）；</p>
</li>
<li>
<p>当源地址收到ICMP Port Unreachable包时停止traceroute。</p>
</li>
</ol>
<p>注：</p>
<ol>
<li>Linux和Mac OS等系统使用UDP包进行探测，目标端口号默认为33434，每次探测目标端口号加1。Traceroute故意使用了一个大于 30000 的目标端口号，以保证目标地址收到数据包后能够返回一个“端口不可达”的 ICMP 报文，于是源地址就可将端口不可达报文当作跟踪结束的标志。</li>
</ol>
<p>2.Traceroute每跳默认发送3个探测包（发包的数量可通过-q进行设置），探测包的返回会受到网络情况的影响。如果防火墙封掉了ICMP的返回信息，那么相应的延时位置会以*显示。如果某台网关阻塞或者某台DNS出现问题，那么相应行的延时会变长。可以加-n 参数来避免DNS解析，以IP格式输出数据。</p>
<p>3.每个探测包都有唯一的标识号，使得Traceroute能够识别返回的包。UDP数据包使用递增的目标端口号进行标识。</p>
<p>三、Tracert实现原理</p>
<p><img src="https://image.3001.net/images/20161026/14774975099553.png!small" alt=""></p>
<ol>
<li>
<p>从源地址发出一个ICMP请求回显（ICMP Echo Request）数据包到目的地址，并将TTL设置为1；</p>
</li>
<li>
<p>到达路由器时，将TTL减1；</p>
</li>
<li>
<p>当TTL变为0时，包被丢弃，路由器向源地址发回一个ICMP超时通知（ICMP Time Exceeded Message），内含发送IP包的源地址，IP包的所有内容及路由器的IP地址；</p>
</li>
<li>
<p>当源地址收到该ICMP包时，显示这一跳路由信息；</p>
</li>
<li>
<p>重复1～5，并每次设置TTL加1；</p>
</li>
<li>
<p>直至目标地址收到探测数据包，并返回ICMP回应答复（ICMPEcho Reply）；</p>
</li>
<li>
<p>当源地址收到ICMP Echo Reply包时停止tracert。</p>
</li>
</ol>
<p>注：</p>
<p>1.Windows系统使用ICMP请求回显（ICMP Echo Request）数据包进行探测，源地址以目的地址返回的ICMP回应答复（ICMP Echo Reply）作为跟踪结束标志。</p>
<p>2.Traceroute每跳默认发送3个探测包。在未能到达路由器或未返回ICMP超时通知的情况下，相应的延时位置会以*显示。</p>
<p>3.每个探测包都有唯一的标识号，ICMP数据包使用seq进行标识。</p>
<p>四、Wireshark抓包解析
本次实验通过追踪本机到达www.baidu.com所经过的路由信息，并使用Wireshark抓取数据包进行简要分析来验证traceroute和tracert的实现原理。</p>
<p>1.Linux/ Mac OS——traceroute
（1）Mac OS</p>
<p>traceroute <a href="http://www.baidu.com">www.baidu.com</a>。</p>
<p><img src="https://image.3001.net/images/20161026/1477497524751.png!small" alt=""></p>
<p>如图，Traceroute能够显示到达目的地址所需的跳数、经过的路由器的IP地址、延时、丢包情况等信息。第一跳为10.203.4.225，第二跳为10.2.30.1，第三跳为10.2.1.1；每条记录输出3个延时结果，说明源地址每次默认发送三个数据包；在11条记录只有1个延时结果，说明源地址只收到了1个ICMP超时通知消息。</p>
<p><img src="https://image.3001.net/images/20161026/14774975311909.png!small" alt=""></p>
<p>如图，源地址10.203.4.244向目的地址119.75.218.70发送UDP数据包，每跳默认发送3个，TTL设置为1；数据包遇到路由器之后，被丢弃，返回Time tolive exceeded超时通知，解析出路由器IP地址10.203.4.225。源地址再发数据包，设置TTL=2，从而解析出第二跳路由10.2.30.1。同理，解析出第三跳路由10.2.1.1。与终端显示的信息相符。</p>
<p>从图中还可以看出，数据包目标端口号从33435开始并且每次加1，traceroute能够通过UDP数据包递增的目标端口号来唯一识别返回的包。</p>
<p><img src="https://image.3001.net/images/20161026/14774975389351.png" alt=""></p>
<p>如图，第11跳的61.51.113.202路由只返回了一个ICMP超时通知，与终端显示的信息相符。</p>
<p><img src="https://image.3001.net/images/20161026/14774975468559.png" alt=""></p>
<p>如图，TTL=34时，ICMP数据包中Type=3(Destination unreachable)，Code=3(Port unreachable)，说明目的地址向源地址发送了端口不可达通知（ICMP Port Unreachable），表示数据包到达目的地址。</p>
<p>（2）Linux</p>
<p>traceroute <a href="http://www.baidu.com">www.baidu.com</a>。
<img src="https://image.3001.net/images/20161026/1477497554123.png" alt="">
<img src="https://image.3001.net/images/20161026/14774975635624.png" alt="">
<img src="https://image.3001.net/images/20161026/14774975706815.png" alt=""></p>
<p>Linux系统下的抓包解析与Mac OS类似。</p>
<ol start="2">
<li>Windows——tracert
tracert <a href="http://www.baidu.com">www.baidu.com</a>。</li>
</ol>
<p><img src="https://image.3001.net/images/20161026/1477497554123.png" alt=""></p>
<p>如图，第一跳为10.8.160.1，第二跳为10.0.14.1，第三跳为10.0.4.41；每条记录输出3个延时结果，说明源地址每次默认发送三个数据包；在第6条记录只有2个延时结果，说明源地址只收到了2个ICMP超时通知消息；数据包从源地址经过15跳之后到达目的地址。</p>
<p><img src="https://image.3001.net/images/20161026/14774975854474.png" alt=""></p>
<p>如图，源地址10.8.169.32向目的地址220.181.111.188发送ICMP请求回显（ICMP Echo Request）数据包，每跳默认发送3个，TTL设置为1；数据包遇到路由器之后，被丢弃，返回Time tolive exceeded超时通知，解析出路由器IP地址10.8.160.1。源地址再发数据包，设置TTL=2，从而解析出第二跳路由10.0.14.1和10.0.14.5。同理，解析出第三跳路由10.0.4.41。与终端显示的信息相符。</p>
<p>从图中还可以看出，数据包从seq=142开始每次加1，tracert能够通过seq来唯一识别返回的包。</p>
<p><img src="https://image.3001.net/images/20161027/14774976021427.png" alt=""></p>
<p>如图，seq=157的数据包没有得到路由器172.16.7.1的超时通知消息，因此第6跳只有两个延时结果，与终端显示的信息相符。</p>
<p><img src="https://image.3001.net/images/20161027/14774976097992.png" alt=""></p>
<p>如图，TTL=15时，源地址收到了目的地址的ICMP回应答复（ICMP Echo Reply），说明源地址经过了15跳到达目的地址，与终端显示信息相符。</p>
<p>五、The Great Cannon案例
2015年3月26日开始，因某些众所周知的原因，GitHub遭到其网站历史上最大规模DDoS攻击。瑞典网络安全公司Netresec通过查看数据包中的TTL值断定这是一起中间人攻击事件。在此过程中，他们借助了路由追踪程序traceroute/tracert的实现原理。首先建立一个正常的连接，确保数据包能够到达目标机器。然后依次发送TTL值为1,2,3…的HTTP请求。若数据包没有到达中间人设备，则不会出现HTTP响应；若数据包到达中间人设备，则会出现HTTP响应，然后只需在出现HTTP响应时，查看请求数据包设置初始TTL值即可。</p>
<p>安全人员根据下图发现中间人设备潜伏在11和12跳之间。Web请求中 TTL 值为11的时候数据包没有响应，而TTL值为12的时候，返回了正常响应。</p>
<p><img src="https://image.3001.net/images/20161026/1477497554123.png" alt=""></p>
<p>六、小结
Traceroute/tracert路由追踪程序是用来追踪数据包到达网络主机所经过的路由信息的重要工具，虽然路由追踪效果一致，但实现原理略有不同：前者借助UDP协议，后者借助ICMP协议。此外，利用TTL追踪攻击主机的位置，也为我们提供了新的思路。</p>
<p>参考资料
[1] <a href="http://www.cnblogs.com/peida/archive/2013/03/07/2947326.html">http://www.cnblogs.com/peida/archive/2013/03/07/2947326.html</a></p>
<p>[2] <a href="http://www.dearda.com/index.php/archives/1361">http://www.dearda.com/index.php/archives/1361</a></p>
<p>[3] <a href="https://translate.google.com/translatehl=zh-CN&amp;sl=en&amp;u=https://technet.microsoft.com/en-us/library/cc940128.aspx&amp;prev=search">https://translate.google.com/translatehl=zh-CN&amp;sl=en&amp;u=https://technet.microsoft.com/en-us/library/cc940128.aspx&amp;prev=search</a></p>
<p>[4] <a href="http://www.freebuf.com/news/topnews/63148.html">http://www.freebuf.com/news/topnews/63148.html</a></p>
<p>[5]https://blog.gesha.net/archives/499/</p>

    </div>

    <div class="post-copyright">
            
            <p class="copyright-item">
                <span>Author:</span>
                <span>Rockwinder </span>
                </p>
            

            
            <p class="copyright-item">
                    <span>Link:</span>
                    <a href=https://rockwinder.github.io/post/traceroute/>https://rockwinder.github.io/post/traceroute/</span>
            </p>
            
            
            <p class="copyright-item lincese">
                本文采用<a rel="license" href="http://creativecommons.org/licenses/by-nc/4.0/" target="_blank">知识共享署名-非商业性使用 4.0 国际许可协议</a>进行许可
            </p>
            
    </div>


    <div class="post-tags">
        
            <section>
            <i class="iconfont icon-tag"></i>Tag(s):
            
            <span class="tag"><a href="https://rockwinder.github.io/tags/traceroute/">
                    #traceroute</a></span>
            
            </section>
        
        <section>
                <a href="javascript:window.history.back();">back</a></span> ·
                <span><a href="https://rockwinder.github.io/">home</a></span>
        </section>
    </div>

    <div class="post-nav">
        
        <a href="https://rockwinder.github.io/post/%E7%A0%94%E5%8F%91%E6%A8%A1%E5%BC%8F%E5%92%8C%E6%B5%81%E7%A8%8B%E7%9A%84%E5%86%8D%E6%80%9D%E8%80%83/" class="prev" rel="prev" title="研发模式和流程的再思考"><i class="iconfont icon-left"></i>&nbsp;研发模式和流程的再思考</a>
        
        
        <a href="https://rockwinder.github.io/post/macos_gdb_install/" class="next" rel="next" title="在macOS上使用GDB的教程">在macOS上使用GDB的教程&nbsp;<i class="iconfont icon-right"></i></a>
        
    </div>

    <div class="post-comment">
        
            
                <div id="gitalk-container"></div>
<link rel="stylesheet" href="https://cdn.bootcss.com/gitalk/1.5.2/gitalk.css">
<script src="https://cdn.bootcss.com/gitalk/1.5.2/gitalk.min.js"></script>
<script>
    const gitalk = new Gitalk({

        clientID: '',
        clientSecret: '',
        repo: '',
        owner: '',
        admin: [''],
        id: location.pathname, 
        distractionFreeMode: false 
    });
    (function () {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('gitalk-container').innerHTML = 'Gitalk comments not available by default when the website is previewed locally.';
            return;
        }
        gitalk.render('gitalk-container');
    })();
</script>

            
        
    </div>
</article>
                </div>
            </main>
            <footer class="footer">
    <div class="copyright">
        &copy;
        
        <span itemprop="copyrightYear">2017 - 2020</span>
        
        <span class="with-love">
    	 <i class="iconfont icon-love"></i>
         </span>
         
            <span class="author" itemprop="copyrightHolder"><a href="https://rockwinder.github.io/">Rockwinder</a> | </span>
         

         
		  <span>Powered by <a href="https://gohugo.io/" target="_blank" rel="external nofollow">Hugo</a> & <a href="https://github.com/Mogeko/Mogege" target="_blank" rel="external nofollow">Mogege</a></span>
    </div>
</footer>





>
<script defer src="/js/vendor_main.min.js"></script>







<script src="https://cdn.jsdelivr.net/npm/pangu@4.0.7/dist/browser/pangu.min.js" integrity="sha256-j+yj56cdEY2CwkVtGyz18fNybFGpMGJ8JxG3GSyO2+I=" crossorigin="anonymous"></script>
<script> pangu.spacingPage();</script>





        </div>
    </body>
</html>
